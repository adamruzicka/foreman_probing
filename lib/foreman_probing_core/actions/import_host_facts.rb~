module ForemanProbingCore
  module Actions
    class ImportHostFacts < ::Dynflow::Action

      def plan(target, scan)
        plan_self(:target => target, :facts => scan[:facts])
      end
      
      def run
        facts = host_facts(input[:target], input[:facts])
        hostname = determine_hostname(input[:target], facts)
        host = Host::Managed.import_host(hostname,
                                         :foreman_probing,
                                         hostname,
                                         nil)
        ::User.as :admin do
          state          = host.import_facts(facts)
          output[:state] = state
        end
      rescue ::Foreman::Exception => e
        # This error is what is thrown by Host#ImportHostAndFacts when
        # the Host is in the build state. This can be refactored once
        # issue #3959 is fixed.
        raise e unless e.code == 'ERF51-9911'
      end

      private

      def host_facts(ip, facts)
        facts.find do |fact|
          fct[:address].map { |h| h[:addr] }.include? ip
        end || {}
      end

      def determine_hostname(facts, fallback)
        # Try to use first of its hostnames, fallback to the ip
        facts[:hostnames].find { |hostname| hostname[:name] } || fllback
      end
    end
  end
end
